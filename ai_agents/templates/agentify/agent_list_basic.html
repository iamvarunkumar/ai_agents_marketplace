{# templates/agentify/agent_list.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Browse AI Agents & Tools{% endblock title %}

{% block content %} {# <-- Main content block starts here #}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10"> {# Consistent width #}
            <div class="glass-panel mt-4 mb-4 p-4 p-md-5">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <div>
                        <h1 class="display-6 fw-bold mb-1">Explore AI Agents & Tools</h1>
                        <p class="text-muted-color mb-0">
                            Discover agents and tools built by the community.
                        </p>
                    </div>
                    {# Tier Toggle Buttons #}
                    <div class="btn-group tier-toggle mt-3 mt-md-0" role="group" aria-label="Tier Toggle">
                        <a href="?tier={{ TIER_BASIC }}" class="btn btn-sm {% if selected_tier == TIER_BASIC %}btn-primary{% else %}btn-outline-secondary{% endif %}">Basic</a>
                        <a href="?tier={{ TIER_PRO }}" class="btn btn-sm {% if selected_tier == TIER_PRO %}btn-primary{% else %}btn-outline-secondary{% endif %}">Pro</a>
                        <a href="?tier={{ TIER_ADVANCED }}" class="btn btn-sm {% if selected_tier == TIER_ADVANCED %}btn-primary{% else %}btn-outline-secondary{% endif %}">Advanced</a>
                    </div>
                </div>

                {# DEBUGGING: Show the currently selected tier #}
                <p class="text-center small text-warning mb-4"><em>(Debug: Selected Tier = {{ selected_tier }})</em></p>


                {# Loop through categorized agents from the view context #}
                {% if categorized_agents %}
                    {% for category_name, agents_in_category in categorized_agents.items %}
                        <div class="category-section mb-5">
                            <h2 class="h4 fw-bold mb-3 category-title">{{ category_name }}</h2>
                            <div class="row g-4">
                                {% for agent in agents_in_category %}
                                    <div class="col-sm-6 col-md-6 col-lg-4"> {# 3 cards per row on large screens #}
                                        {# Pass the agent object to the partial template #}
                                        {% include "partials/agent_card.html" with agent=agent %}
                                    </div>
                                {% empty %}
                                     <p class="text-muted-color">No {{ selected_tier }} agents found in this category.</p>
                                {% endfor %}
                            </div>
                        </div>
                        {# Removed misplaced hr tag #}
                    {% endfor %}

                     {# Optional: Pagination Controls (ensure links include selected tier) #}
                    {% if is_paginated %}
                        <nav aria-label="Agent pagination" class="mt-5 d-flex justify-content-center">
                            <ul class="pagination pagination-sm"> {# Made pagination smaller #}
                                {% if page_obj.has_previous %} <li class="page-item"><a class="page-link" href="?tier={{ selected_tier }}&page={{ page_obj.previous_page_number }}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
                                {% else %} <li class="page-item disabled"><span class="page-link" aria-hidden="true">&laquo;</span></li> {% endif %}

                                {% for i in paginator.page_range %}
                                  {% if page_obj.number == i %} <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
                                  {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %} <li class="page-item"><a class="page-link" href="?tier={{ selected_tier }}&page={{ i }}">{{ i }}</a></li>
                                  {% elif i == paginator.page_range.0 or i == paginator.page_range|last %}
                                     {% if i == paginator.page_range.0 and page_obj.number > 4 %} <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                                     {% elif i == paginator.page_range|last and page_obj.number < paginator.num_pages|add:"-3" %} <li class="page-item disabled"><span class="page-link">&hellip;</span></li> {% endif %}
                                     <li class="page-item"><a class="page-link" href="?tier={{ selected_tier }}&page={{ i }}">{{ i }}</a></li>
                                  {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %} <li class="page-item"><a class="page-link" href="?tier={{ selected_tier }}&page={{ page_obj.next_page_number }}" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>
                                {% else %} <li class="page-item disabled"><span class="page-link" aria-hidden="true">&raquo;</span></li> {% endif %}
                            </ul>
                        </nav>
                    {% endif %}

                {% else %}
                     {# Message if NO agents found for the selected tier #}
                    <p class="text-center text-muted-color mt-5">No agents found for the '{{ selected_tier }}' tier in the marketplace.</p>
                    <p class="text-center text-muted-color small">(Ensure agents exist in the database, are marked 'public', and have the correct tier assigned in the admin.)</p>
                {% endif %}

            </div> {# End Main Panel #}
        </div> {# End Column #}
    </div> {# End Row #}
</div>
{% endblock content %} {# <-- Correctly closing the content block HERE #}


{% block extra_head %} {# <-- Starting extra_head block AFTER content block is closed #}
<style>
    .category-title {
        color: var(--primary-color);
        border-bottom: 1px solid var(--glass-border);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem !important;
    }
    /* Tier Toggle Group Styling */
    .tier-toggle .btn {
        min-width: 80px;
    }
    /* Style pagination for dark theme */
    .pagination .page-link { background-color: rgba(255, 255, 255, 0.05); border-color: var(--glass-border); color: var(--text-muted-color); }
    .pagination .page-link:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--text-color); }
    .pagination .page-item.active .page-link { background-color: var(--primary-color); border-color: var(--primary-color); color: #fff; }
    .pagination .page-item.disabled .page-link { background-color: transparent; border-color: var(--glass-border); color: rgba(255, 255, 255, 0.3); }
</style>
{% endblock extra_head %}